# Pusher å³æ™‚æ›´æ–°æ¸¬è©¦æŒ‡å—

## ğŸ“‹ æ¸¬è©¦å‰æº–å‚™

### 1. ç¢ºèªç’°å¢ƒè®Šæ•¸

**å‰ç«¯** (`frontend/.env` æˆ– `frontend/.env.local`):
```bash
VITE_PUSHER_KEY=e040611d648461743ae2
VITE_PUSHER_CLUSTER=ap1
VITE_BACKEND_URL=http://localhost:3000
```

**å¾Œç«¯** (`backend/.env`):
```bash
PUSHER_APP_ID=2084567
PUSHER_KEY=e040611d648461743ae2
PUSHER_SECRET=91c55ab3e60e0fef2314
PUSHER_CLUSTER=ap1
```

### 2. ç¢ºèªæœå‹™é‹è¡Œ

- âœ… å¾Œç«¯: `http://localhost:3000` (å·²ç¢ºèªé‹è¡Œä¸­)
- âœ… å‰ç«¯: `http://localhost:5173` æˆ– `http://localhost:5174`

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦ 1: Pusher é€£ç·šç‹€æ…‹

1. æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12)
2. å‰å¾€ `http://localhost:5173/events/:id` (æ›¿æ› `:id` ç‚ºå¯¦éš›çš„ event ID)
3. æŸ¥çœ‹ Console æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   [usePusher] Initializing Pusher
   [usePusher] Pusher connected
   [usePusher] âœ“ Successfully subscribed to channel event-{id}
   ```

**é æœŸçµæœ**: 
- âœ… Pusher æˆåŠŸé€£ç·š
- âœ… æˆåŠŸè¨‚é–± channel `event-{id}`
- âŒ å¦‚æœçœ‹åˆ° "Pusher configuration missing"ï¼Œæª¢æŸ¥ç’°å¢ƒè®Šæ•¸

---

### æ¸¬è©¦ 2: location-update äº‹ä»¶

**è§¸ç™¼æ–¹å¼**: æˆå“¡æ›´æ–°ä½ç½®æ™‚ï¼Œå¾Œç«¯æœƒè‡ªå‹•ç™¼é€ `location-update` äº‹ä»¶

**æ¸¬è©¦æ–¹æ³•**:
1. æ‰“é–‹å…©å€‹ç€è¦½å™¨è¦–çª—ï¼ˆæˆ–ä½¿ç”¨ç„¡ç—•æ¨¡å¼ï¼‰
2. å…©å€‹è¦–çª—éƒ½åŠ å…¥åŒä¸€å€‹ event
3. åœ¨è¦–çª— A ä¸­ï¼Œå¦‚æœæˆå“¡æœ‰åˆ†äº«ä½ç½®ï¼Œä½ç½®æœƒè‡ªå‹•æ›´æ–°
4. æŸ¥çœ‹è¦–çª— B çš„ Consoleï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   [EventRoom] Received location-update event: {
     memberId: X,
     nickname: "...",
     lat: ...,
     lng: ...,
     timestamp: "..."
   }
   ```

**é æœŸçµæœ**:
- âœ… è¦–çª— B çš„æˆå“¡åˆ—è¡¨è‡ªå‹•æ›´æ–°è©²æˆå“¡çš„ä½ç½®
- âœ… åœ°åœ–ä¸Šçš„æ¨™è¨˜è‡ªå‹•ç§»å‹•åˆ°æ–°ä½ç½®
- âœ… æˆå“¡åˆ—è¡¨é‡æ–°æ’åºï¼ˆå¦‚æœç‹€æ…‹æ”¹è®Šï¼‰

**æ‰‹å‹•è§¸ç™¼** (å¦‚æœå¾Œç«¯ API å¯ç”¨):
```bash
# æ›´æ–°æˆå“¡ä½ç½®
curl -X POST http://localhost:3000/events/{eventId}/location \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "lat": 25.033,
    "lng": 121.565
  }'
```

---

### æ¸¬è©¦ 3: member-arrived äº‹ä»¶

**è§¸ç™¼æ–¹å¼**: æˆå“¡é»æ“Šã€Œæˆ‘åˆ°äº†ã€æŒ‰éˆ•æ™‚ï¼Œå¾Œç«¯æœƒç™¼é€ `member-arrived` äº‹ä»¶

**æ¸¬è©¦æ–¹æ³•**:
1. æ‰“é–‹å…©å€‹ç€è¦½å™¨è¦–çª—
2. å…©å€‹è¦–çª—éƒ½åŠ å…¥åŒä¸€å€‹ event
3. åœ¨è¦–çª— A ä¸­ï¼Œé»æ“Šã€Œæˆ‘åˆ°äº†ã€æŒ‰éˆ•
4. æŸ¥çœ‹è¦–çª— B çš„ Consoleï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   [EventRoom] Received member-arrived event: {
     memberId: X,
     nickname: "...",
     arrivalTime: "...",
     status: "early" | "ontime" | "late"
   }
   ```

**é æœŸçµæœ**:
- âœ… è¦–çª— B é¡¯ç¤º Snackbar: "ğŸ‰ {nickname} å·²åˆ°é”ï¼"
- âœ… è¦–çª— B çš„æˆå“¡åˆ—è¡¨ä¸­ï¼Œè©²æˆå“¡ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²åˆ°é”ã€
- âœ… æˆå“¡åˆ—è¡¨é‡æ–°æ’åºï¼ˆå·²åˆ°é”çš„æ’åœ¨æœ€å‰é¢ï¼‰
- âœ… å¦‚æœè¦–çª— B æ˜¯ç•¶å‰ç”¨æˆ¶ï¼Œ`hasArrived` ç‹€æ…‹æœƒæ›´æ–°

---

### æ¸¬è©¦ 4: poke äº‹ä»¶

**è§¸ç™¼æ–¹å¼**: æˆå“¡æˆ³å¦ä¸€å€‹æˆå“¡æ™‚ï¼Œå¾Œç«¯æœƒç™¼é€ `poke` äº‹ä»¶

**æ¸¬è©¦æ–¹æ³•**:
1. æ‰“é–‹å…©å€‹ç€è¦½å™¨è¦–çª—
2. å…©å€‹è¦–çª—éƒ½åŠ å…¥åŒä¸€å€‹ event
3. åœ¨è¦–çª— A ä¸­ï¼Œé»æ“Šè¦–çª— B å°æ‡‰æˆå“¡çš„ã€Œæˆ³ã€æŒ‰éˆ•
4. æŸ¥çœ‹è¦–çª— B çš„ Consoleï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   [EventRoom] Received poke event: {
     fromMemberId: X,
     fromNickname: "...",
     toMemberId: Y,
     toNickname: "...",
     count: 1
   }
   ```

**é æœŸçµæœ**:
- âœ… è¦–çª— B é¡¯ç¤ºç€è¦½å™¨é€šçŸ¥ï¼ˆå¦‚æœå·²æˆæ¬Šï¼‰
- âœ… è¦–çª— B é¡¯ç¤º Snackbarï¼ˆå¦‚æœé€šçŸ¥è¢«é˜»æ“‹ï¼‰
- âœ… è¦–çª— B çš„æˆå“¡å¡ç‰‡å¯èƒ½æœ‰å‹•ç•«æ•ˆæœ

---

### æ¸¬è©¦ 5: event-ended äº‹ä»¶

**æ³¨æ„**: å¾Œç«¯å¯èƒ½é‚„æ²’æœ‰å¯¦ä½œè‡ªå‹•è§¸ç™¼ `event-ended` äº‹ä»¶çš„é‚è¼¯ã€‚

**æ¸¬è©¦æ–¹æ³•** (å¦‚æœå¾Œç«¯æœ‰æ‰‹å‹•è§¸ç™¼ API):
1. ç­‰å¾… event çµæŸï¼Œæˆ–æ‰‹å‹•è§¸ç™¼çµæŸäº‹ä»¶
2. æŸ¥çœ‹ Consoleï¼Œæ‡‰è©²çœ‹åˆ°ï¼š
   ```
   [EventRoom] Received event-ended event: {
     eventId: X,
     endedAt: "..."
   }
   ```

**é æœŸçµæœ**:
- âœ… é¡¯ç¤º Snackbar: "ğŸŠ èšæœƒå·²çµæŸï¼æŸ¥çœ‹æ’è¡Œæ¦œçµæœ"
- âœ… `event.status` æ›´æ–°ç‚º `'ended'`
- âš ï¸ EventResultPopup å°šæœªå¯¦ä½œï¼Œæ‰€ä»¥ä¸æœƒè‡ªå‹•å½ˆå‡º

---

## ğŸ” é™¤éŒ¯æŠ€å·§

### æª¢æŸ¥ Pusher é€£ç·š

åœ¨ Console ä¸­è¼¸å…¥ï¼š
```javascript
// æª¢æŸ¥ Pusher å¯¦ä¾‹
window.Pusher
```

### æª¢æŸ¥ Channel è¨‚é–±ç‹€æ…‹

æŸ¥çœ‹ Console æ—¥èªŒä¸­çš„ï¼š
```
[usePusher] âœ“ Successfully subscribed to channel event-{id}
```

### æª¢æŸ¥äº‹ä»¶æ¥æ”¶

æ‰€æœ‰ Pusher äº‹ä»¶éƒ½æœƒåœ¨ Console ä¸­è¨˜éŒ„ï¼Œæ ¼å¼ï¼š
```
[usePusher] âœ“ Event received: {eventName}
[EventRoom] Received {eventName} event: {data}
```

### å¸¸è¦‹å•é¡Œ

1. **Pusher é€£ç·šå¤±æ•—**
   - æª¢æŸ¥ `VITE_PUSHER_KEY` å’Œ `VITE_PUSHER_CLUSTER` æ˜¯å¦æ­£ç¢º
   - æª¢æŸ¥å¾Œç«¯ `PUSHER_*` ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢º
   - æª¢æŸ¥ç¶²è·¯é€£ç·š

2. **è¨‚é–±å¤±æ•—**
   - ç¢ºèª event ID æ˜¯å¦æ­£ç¢º
   - æª¢æŸ¥å¾Œç«¯æ˜¯å¦æœ‰è©² event

3. **äº‹ä»¶æ²’æœ‰æ”¶åˆ°**
   - æª¢æŸ¥å¾Œç«¯ Consoleï¼Œç¢ºèªæ˜¯å¦æœ‰è§¸ç™¼äº‹ä»¶
   - æª¢æŸ¥å¾Œç«¯æ—¥èªŒä¸­çš„ `[Pusher] âœ“ Successfully triggered event`
   - ç¢ºèª channel åç¨±æ ¼å¼æ­£ç¢ºï¼š`event-{id}`

---

## ğŸ“ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] Pusher æˆåŠŸé€£ç·š
- [ ] æˆåŠŸè¨‚é–± channel
- [ ] location-update äº‹ä»¶æ­£å¸¸æ¥æ”¶ä¸¦æ›´æ–° UI
- [ ] member-arrived äº‹ä»¶æ­£å¸¸æ¥æ”¶ä¸¦æ›´æ–° UI
- [ ] poke äº‹ä»¶æ­£å¸¸æ¥æ”¶ä¸¦é¡¯ç¤ºé€šçŸ¥
- [ ] event-ended äº‹ä»¶æ­£å¸¸æ¥æ”¶ï¼ˆå¦‚æœå¾Œç«¯æœ‰å¯¦ä½œï¼‰
- [ ] å¤šå€‹ç€è¦½å™¨è¦–çª—åŒæ­¥æ­£å¸¸
- [ ] åœ°åœ–æ¨™è¨˜è‡ªå‹•æ›´æ–°
- [ ] æˆå“¡åˆ—è¡¨è‡ªå‹•æ’åº
- [ ] Snackbar é€šçŸ¥æ­£å¸¸é¡¯ç¤º

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæ¸¬è©¦å¾Œï¼š
1. å¦‚æœæ‰€æœ‰æ¸¬è©¦é€šéï¼Œå¯ä»¥ push ä¸¦ squash merge
2. å¦‚æœæœ‰å•é¡Œï¼Œè¨˜éŒ„éŒ¯èª¤è¨Šæ¯ä¸¦ä¿®å¾©
3. å¯¦ä½œ EventResultPopup å…ƒä»¶ï¼ˆå¾…å¾ŒçºŒ issueï¼‰

